\documentclass[english]{article}

\usepackage{graphicx}
\usepackage{alltt}
\usepackage{url}
%\usepackage{ngerman}
\usepackage{color}
\usepackage{enumitem}
\usepackage{listings}



\title{\huge\sffamily\bfseries Review of Group 4 by Group 1}
\author{Cyrill Kr\"ahenb\"uhl \and Silvan Egli \and Lukas Bischofberger}
\date{\today}


\begin{document}
\maketitle

%% **** please observe the page limit ****
%% (it is not allowed to change the font size or page geometry to gain more space!)
%% comment or remove lines below before hand-in
\begin{center}
{\large\textcolor{red}{Page limit: 18 pages.}}
\end{center}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\tableofcontents
\pagebreak



\section{Background}

\noindent {\bf Developers of the external system:} {\it Badoux Nicolas, Chibotaru Victor, Ilunga Marc} \\

\noindent {\bf Date of the review:} 6th December 2016


\section{Report and Design Review}

Study the documentation that came with the external system and evaluation. 

\subsection{System Architecture and Security Concepts} (TODO Cyrill)

Is the chosen architecture well-suited for the tasks specified in the requirements? Are the security design decisions well motivated and justified? List positive and negative aspects for each question.


\subsection{Risk Analysis} %(TODO Lukas)

%Is the risk analysis coherent and complete? That is, are all relevant assets, threat sources, and threats listed? 
%
%Are the risk definitions (likelihood, impact, and risk) reasonable?
%
%Are the countermeasures appropriate?
%2.4.5 -2 -> HTTPS does not prevent MITM attack
In this section we will discuss the evaluated assets, the according threats and countermeasures. We point out the validity of the threats and countermeasures and if their likelihood and impacts are defined appropriately. For this we list up the assets:

\paragraph{Web Server}
In general the threats and their countermeasure seem appropriate, but there are a few threats missing. The analysis focuses mostly on rendering the service unavailable but does not talk about integrity of the systems. For example a possible threat that a hacker or malware could get access to the system and install sniffing software or similar is not considered. Also it does not mention the possibility of changing the service in a non-destructive manner.
Furthermore we think that the impact of a DDoS is rated too high, as it would probably only cause a temporary service outage which is nowhere as bad as a compromise of e.g the CA root key. 

\paragraph{Database Server}
fine

\paragraph{Backup and Log Server}
install stuff again?

\paragraph{Firewall}   
firewall not serving its purpose?

Physical assets are not discussed enough regarding their physical threats. What about component failure? (various reasons) 
Disk encryption seems not enough?
Copy paste -> verbosity not useful
Networks?
countermeasures seem correct for the proposed threats, but hard to implement in practice


\paragraph{Private Keys}
steal private keys impact is too high, likelihood too low

where are sever keys?

\paragraph{User Data}
likelihoods possibly too low

\paragraph{System Logs} 
what about internal tampering? deleting logs, adding logs?

\paragraph{Internet connection} 
availability missing
internal vs external internet?
hardware components?

\paragraph{Trust} 
data leakage of some sort for some reason?

\paragraph{Persons}

DDOS can be helped even in a simple approach
CA keys?
system configurations and implementation?
	

\section{Implementation Review}
 
\subsection{Compliance with Requirements} 

%Does the system meet the functional and security requirements given in the assignment? Are they implemented correctly? If not, list any missing functionality %or security measure.
In the following we will analyze the implementation of the functional and security requirements given in the project assignment.

\subsubsection{Functional Requirements} (TODO Silvan)

\begin{enumerate}

\item \textbf{Certificate Issuing: }
The web application provides all requested functionality needed for the Certificate Issuing Process. This includes login with credentials or user certificate, changing the user's information, requesting a new certificate, displaying the the new certificate in a list along with all other valid (not yet revoked) certificates and the possibility to download all valid certificates. Client certificates are issued by an intermediate CA which uses a certificate signed by the root CA. 

\item \textbf {Login with client certificate: }
For the login with client certificates, the web server (nginx) verifies the certificate using the intermediate and root CA's certificates. The result is then forwarded together with the user certificate to the backend (Flask application) which checks if the certificate is not revoked and whether the user id (uid) provided in the certificate's subject field exists. If so the user gets loged in.

\item \textbf{Certificate Revocation: }
In the list of valid certificates there is a revoke link allowing the user to revoke the corresponding certificate. Before revoking, the backend  checks if the certificate was not already revoked. The revocation process includes the update of the CRL. Login with revoked certificates is prevented by the backend as described above. The newly generated CRL is published on the web server. The CRL however is only accessible for loged in users for which we don't see any specific reason. Moreover, the CRL contains no signature which bars the user from verifying the CRL's authenticity.

\item \textbf{CA Administrator Interface: }
CA administrators can inspect the CA's current state through a dedicated web interface. They must provide a valid user certificate in order to authenticate. The implementation of the authentication is handled in the same way as for a normal user. As a last step, the backend checks if the user in the certificate is listed in the ca_admins.txt file which contains the name of all CA administrators. This prevents a normal user from accessing the admin interface.

\item \textbf{Key Backup: }



\item \textbf{System Administration and Maintenance: }
\end{enumerate}
\subsubsection{Security Requirements} (TODO Cyrill)
\begin{enumerate}

\item \textbf{Access Control with regard to CA Functionality and Data}
\item \textbf{Secrecy and Integrity for Private Keys in Backup}
\item \textbf{Secrecy and Integrity for User Data}
\item \textbf{Access Control on all Components}
\begin{enumerate}[label=(\alph*)]
\item \textbf{Firewall}:
\item \textbf{Webbox}:
\item \textbf{Sqlbox}:
\item \textbf{Logbox}:
\end{enumerate}
\end{enumerate}
\subsubsection*{Observations}

\subsection{System Security Testing} (TODO alle)

%Systematically investigate the system. Are the countermeasures implemented as %described? Do you see any security problems? Analyze the system using both %black-box as well as white-box testing.

\subsubsection{Countermeasures}
In this section we will discuss the implementation of the proposed countermeasures in the risk analysis. The number after each countermeasure corresponds to the number in the risk analysis.

\paragraph{Web Server}
\begin{enumerate}[label=(\alph*)] \item \textbf{FDE\footnote{\url{https://en.wikipedia.org/wiki/Disk_encryption}}}:
\item \textbf{DDOS (2)}
\item \textbf{Monitor Intrusion and Attacks (4)}:
\item \textbf{Monitoring Logs (5)}:
\end{enumerate} 

\paragraph{Database Server}

\paragraph{Backup and Log Server}

\paragraph{Firewall}   

\paragraph{Private Keys}
\begin{enumerate}[label=(\alph*)]
\item \textbf{Access Control (1)}:
\item \textbf{HTTPS (2)}:
\item \textbf{Notification Channel for Irregularities (3)}
\end{enumerate} 

\paragraph{User Data}
\begin{enumerate}[label=(\alph*)]
\item \textbf{Access Control (1)}:
\item \textbf{HTTPS (2)}:
\item \textbf{Notification Channel for Irregularities (3)}
\end{enumerate}

\paragraph{System Logs} 

\paragraph{Internet connection} 

\paragraph{Trust} 

\paragraph{Persons}


\subsubsection{Testing}

Black box testing
\begin{itemize}
	
	\item Nessus scanner
	\item nmap -> 12345 is open UDP
	\item ZAP
	\item By Hand

\end{itemize}

White box testing

\begin{itemize}
	\item Firewall: 12345 -> to webbox\\ openssh-sftp-server installed,  
\end{itemize}



\subsection{Backdoors}

%Describe all backdoors that you found on the system. It may be that you also %find unintended backdoors (only the group's presentation will show whether %they were intended or not).

\subsubsection{Command Injection}
Command injection is an attack in which the goal is execution of arbitrary commands on the host operating system via a vulnerable application \footnote{\url{https://www.owasp.org/index.php/Command_Injection}}.\\
 When issuing a new user certificate, the Flask application takes the information on the user from the database and creates an openssl system command in the form of a string. This command is then executed by making use of Python's subprocess module \footnote{\url{https://docs.python.org/2/library/subprocess.html}} with the privileges of the Flask application (caweb user). 
 We found the vulnerability by looking at the certificate's subject field containing an organizationalUnitName (OU) attribute which maps to the user's first name. Furthermore the result of the executed system command is returned as an HTML comment in the index.html file.
 
 \paragraph{Vulnerability:}
 The vulnerability arises from two inattentions:
\begin{enumerate}
\item \textbf{Insufficient user input validation:} The only restriction on the user's first name is the length of 64 characters. Appart from that any string is allowed.
\item \textbf{shell=True:} Setting shell=True in Python's subprocess module makes the command beeing executed through the shell, allowing any useage of shell supported features such as command substitution. 
\end{enumerate}

\paragraph{Impact:} As a result of the vulnerability the user can execute any shell command which has the privileges of the Flask application (caweb user). This includes access to the application's settings (such as secret key) and also the possibility to act as the CA which means having all the functionality of the CA (e.g. issuing/revoking certificates) as well as access to the users' and in the intermediate CA's private keys.

\paragraph{Exploit:}
The space of possible commands beeing executed by any user is only limited by the privileges of the caweb user. As an example: by setting the first name to the following string 
\begin{lstlisting}[language=bash]
$(grep -rw secret_key app/|sed 's/\ /*/g;s/\//*/g'\)
\end{lstlisting}
and then issuing a certificate, we were able to compromise the applications secret key by retrieving it from the OU attribute in the certificate's subject field. We then could have created a cookie for an arbitrary user and sign it with the secret key. 

\paragraph{Mitigation:} The vulnerability could be mitigated by
\begin{enumerate}
\item Properly sanitize the user's input by allowing only alphanumerical characters for example. Note that this should be done on any field not only first name as they are vulnerable too. 
\item Setting shell=False in the subprocess module and therefore disable all shell based features. In case the application relies on any shell based features it should use the wrappers provided by python. (e.g. os.walk())
\end{enumerate}

\subsection{UDP Bash}
We discovered, that the port 12345 for UDP packets is open on the firewall. Upon further inspection we discovered, that communication on this port is nated to the webserver where a hidden process (executed by root, located in /home/admin/.hidden/a.out) is listening on the port. Using some reverse engineering we discovered the password (6p9mkXhw) which needs to be sent when connecting to the mentioned port using e.g.
\begin{lstlisting}[language=bash]
$nc 192.168.56.10 12345 -u
\end{lstlisting}

Then we got access to the webserver bash as a root user, which allows to execute whatever command we like.

\section{Comparison} (TODO alle)

Compare your system with the external system you were given for the review. Are there any remarkable highlights in your system or the external system?

\begin{itemize}
	\item we didn't do FDE for usability reasons
	\item We use a separate CA server, they have CA stuff on the webserver
	\item they encrypt the client certificates with a password, we don't. but as they use the same key for all certificates security doesn't really increase. can even lead to false security feeling.
	\item they have no ddos protection
	\item 
\end{itemize}

\subsection{Functional}

\subsection{Security}


\end{document}

%%% Local Variables: 
%%% mode: latex
%%% TeX-master: "../../book"
%%% End: 

%Maybe useful : https://netsec.ws/?p=309
